---
interface Props {
  files: {
    name: string;
    language?: string;
    code: string;
    highlight?: string;
  }[];
}

const { files } = Astro.props;
const id = `codegroup-${Math.random().toString(36).substring(7)}`;
---

<div class="not-prose my-6" data-code-group={id}>
  <!-- File tabs -->
  <div class="flex gap-1 overflow-x-auto rounded-t-lg bg-gray-800 px-2 pt-2">
    {
      files.map((file, index) => (
        <button
          type="button"
          class:list={[
            'code-tab flex items-center gap-2 rounded-t-md px-4 py-2 text-sm font-medium transition-colors',
            index === 0 ? 'bg-gray-900 text-white' : 'text-gray-400 hover:text-gray-200',
          ]}
          data-tab-index={index}
        >
          <span class="file-icon">
            {file.language === 'typescript' || file.language === 'ts' ? 'ğŸ“˜' : ''}
            {file.language === 'javascript' || file.language === 'js' ? 'ğŸ“’' : ''}
            {file.language === 'python' || file.language === 'py' ? 'ğŸ' : ''}
            {file.language === 'bash' || file.language === 'shell' ? 'ğŸ’»' : ''}
            {file.language === 'json' ? 'ğŸ“‹' : ''}
            {file.language === 'yaml' || file.language === 'yml' ? 'âš™ï¸' : ''}
            {![
              'typescript',
              'ts',
              'javascript',
              'js',
              'python',
              'py',
              'bash',
              'shell',
              'json',
              'yaml',
              'yml',
            ].includes(file.language || '')
              ? 'ğŸ“„'
              : ''}
          </span>
          {file.name}
        </button>
      ))
    }
  </div>

  <!-- Code panels -->
  <div class="relative">
    {
      files.map((file, index) => (
        <div class:list={['code-panel', index !== 0 && 'hidden']} data-panel-index={index}>
          <div class="group relative">
            <button
              class="copy-button absolute top-3 right-3 z-10 rounded bg-gray-700 px-3 py-1.5 text-xs font-medium text-white opacity-0 transition-opacity group-hover:opacity-100 hover:bg-gray-600"
              data-code={file.code}
              aria-label="Copy code"
            >
              <span class="copy-text">Copy</span>
              <span class="copied-text hidden">Copied!</span>
            </button>
            <pre class="overflow-x-auto rounded-t-none rounded-b-lg bg-gray-900 p-4 text-sm">
              <code class="text-gray-100" data-language={file.language}>
                {file.code}
              </code>
            </pre>
          </div>
        </div>
      ))
    }
  </div>
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    const codeGroups = document.querySelectorAll('[data-code-group]');

    codeGroups.forEach((group) => {
      const tabs = group.querySelectorAll('.code-tab');
      const panels = group.querySelectorAll('.code-panel');

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const index = tab.getAttribute('data-tab-index');

          // Update tabs
          tabs.forEach((t, i) => {
            if (i.toString() === index) {
              t.classList.add('bg-gray-900', 'text-white');
              t.classList.remove('text-gray-400');
            } else {
              t.classList.remove('bg-gray-900', 'text-white');
              t.classList.add('text-gray-400');
            }
          });

          // Update panels
          panels.forEach((p, i) => {
            if (i.toString() === index) {
              p.classList.remove('hidden');
            } else {
              p.classList.add('hidden');
            }
          });
        });
      });

      // Copy functionality (per-group)
      const copyButtons = group.querySelectorAll('.copy-button');
      copyButtons.forEach((button) => {
        button.addEventListener('click', async () => {
          const code = button.getAttribute('data-code') || '';
          try {
            await navigator.clipboard.writeText(code);
          } catch (err) {
            // Fallback for environments without navigator.clipboard
            const textarea = document.createElement('textarea');
            textarea.value = code;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }

          const copyText = button.querySelector('.copy-text');
          const copiedText = button.querySelector('.copied-text');

          if (copyText && copiedText) {
            copyText.classList.add('hidden');
            copiedText.classList.remove('hidden');

            setTimeout(() => {
              copyText.classList.remove('hidden');
              copiedText.classList.add('hidden');
            }, 2000);
          }
        });
      });
    });
  });
</script>
