---
interface Props {
  caption?: string;
}

const { caption } = Astro.props;
---

<figure class="not-prose my-8">
  <div class="mermaid-container overflow-hidden rounded-lg border border-gray-200 bg-white p-6">
    <div class="mermaid-diagram">
      <slot />
    </div>
  </div>
  {
    caption && (
      <figcaption class="mt-3 text-center text-sm text-gray-600 dark:text-gray-400">
        {caption}
      </figcaption>
    )
  }
</figure>

<script>
  import mermaid from 'mermaid';

  // Initialize Mermaid
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose',
    themeVariables: {
      primaryColor: '#3b82f6',
      primaryTextColor: '#1f2937',
      primaryBorderColor: '#60a5fa',
      lineColor: '#6b7280',
      secondaryColor: '#10b981',
      tertiaryColor: '#f59e0b',
      background: '#ffffff',
      mainBkg: '#ffffff',
      secondBkg: '#ffffff',
      tertiaryBkg: '#ffffff',
      border1: '#d1d5db',
      border2: '#9ca3af',
      note: '#fef3c7',
      noteBorder: '#fbbf24',
      noteBkg: '#fef3c7',
      clusterBkg: '#ffffff',
      clusterBorder: '#d1d5db',
    },
  });

  // Function to render diagrams
  async function renderDiagrams() {
    const diagrams = document.querySelectorAll('.mermaid-diagram');
    
    for (const diagram of diagrams) {
      // Get the code from the pre > code block
      const codeBlock = diagram.querySelector('pre code');
      if (codeBlock) {
        const mermaidCode = codeBlock.textContent || '';
        
        // Create a unique ID for this diagram
        const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
        
        try {
          // Render the diagram
          const { svg } = await mermaid.render(id, mermaidCode);
          
          // Replace the code block with the rendered SVG
          diagram.innerHTML = svg;
        } catch (error) {
          console.error('Mermaid rendering error:', error);
          // Keep the code block if rendering fails
        }
      }
    }
  }

  // Render on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderDiagrams);
  } else {
    renderDiagrams();
  }

  // Re-render on view transitions (Astro)
  document.addEventListener('astro:page-load', renderDiagrams);
</script>

<style>
  .mermaid-container {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .mermaid-diagram {
    width: 100%;
    display: flex;
    justify-content: center;
  }

  .mermaid-diagram :global(svg) {
    max-width: 100%;
    height: auto;
  }

  /* Hide the code block while rendering */
  .mermaid-diagram pre {
    display: none;
  }
</style>
