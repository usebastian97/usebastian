---
import MainLayout from '@layouts/MainLayout.astro';
import BlogHero from '../components/BlogHero.astro';
import BlogGrid from '../components/BlogGrid.astro';
import { useTranslations } from '@i18n/utils';
import { getCollection } from 'astro:content';
import { blogCategories } from '../../../data/blogCategories';

const t = useTranslations('en');

export async function getStaticPaths() {
  return blogCategories.map((category) => ({
    params: { category: category.slug },
    props: { category },
  }));
}

const { category } = Astro.props as {
  category: (typeof blogCategories)[number];
};

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime())
  .filter((post) => post.data.tags?.some((tag) => category.tags.includes(tag)));

const postsPerPage = Math.max(posts.length, 1);
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const blogListSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: `${category.label} Articles`,
  description:
    'Articles on Microsoft 365 architecture, Power Platform governance, security and compliance, and Microsoft 365 Copilot adoption.',
  url: canonicalURL.href,
  mainEntity: {
    '@type': 'ItemList',
    itemListElement: posts.map((post, index) => {
      const postUrl = new URL(`/blog/${post.slug}`, Astro.site).href;
      const postImage = post.data.image
        ? new URL(post.data.image, Astro.site).href
        : undefined;

      return {
        '@type': 'ListItem',
        position: index + 1,
        item: {
          '@type': 'BlogPosting',
          name: post.data.title,
          url: postUrl,
          image: postImage ? [postImage] : undefined,
        },
      };
    }),
  },
};
---

<MainLayout
  title={`${category.label} | ${t('blog.title')}`}
  description="Articles on Microsoft 365 architecture, Power Platform governance, security and compliance, and Microsoft 365 Copilot adoption."
>
  <head>
    <script type="application/ld+json" set:html={JSON.stringify(blogListSchema)} />
  </head>
  <section class="bg-white py-20">
    <div class="mx-auto max-w-[1600px] px-6 sm:px-8 lg:px-12">
      <BlogHero />

      <!-- Separator -->
      <div class="my-12 border-t border-gray-200"></div>

      <!-- Sidebar + Content Layout -->
      <div class="flex flex-col gap-6 lg:flex-row lg:gap-8">
        <!-- Sidebar -->
        <aside class="lg:w-48 lg:flex-shrink-0">
          <div class="sticky top-8 space-y-4">
            <!-- Categories -->
            <div>
              <h2 class="mb-2">Latest</h2>
              <nav class="space-y-1">
                <a
                  href="/blog"
                  class="block rounded-md px-2 py-1.5 text-sm text-gray-700 transition-colors hover:bg-gray-100"
                >
                  All Posts
                </a>
              </nav>
            </div>

            <!-- Topics -->
            <div>
              <h2 class="mb-2">Topics</h2>
              <nav class="space-y-1">
                {
                  blogCategories.map((item) => (
                    <a
                      href={`/blog/category/${item.slug}`}
                      class:list={[
                        'block rounded-md px-2 py-1.5 text-sm transition-colors',
                        item.slug === category.slug
                          ? 'bg-gray-100 text-gray-900'
                          : 'text-gray-700 hover:bg-gray-100',
                      ]}
                    >
                      {item.label}
                    </a>
                  ))
                }
              </nav>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1">
          <BlogGrid posts={posts} currentPage={1} postsPerPage={postsPerPage} />
        </div>
      </div>
    </div>
  </section>
</MainLayout>
