---
import MainLayout from '@layouts/MainLayout.astro';
import BlogHero from './components/BlogHero.astro';
import BlogGrid from './components/BlogGrid.astro';
import { useTranslations } from '@i18n/utils';
import { getCollection } from 'astro:content';
import { blogCategories } from '../../data/blogCategories';

const t = useTranslations('en');
const POSTS_PER_PAGE = 9;

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort(
  (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()
);
const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);

export async function getStaticPaths() {
  const postsPerPage = 9;
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  const total = Math.ceil(entries.length / postsPerPage);

  if (total <= 1) {
    return [];
  }

  return Array.from({ length: total - 1 }, (_, index) => {
    const page = index + 2;
    return {
      params: { page: String(page) },
      props: { page },
    };
  });
}

const { page } = Astro.props as { page: number };
const currentPage = Math.min(Math.max(2, Number(page)), Math.max(totalPages, 2));
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const blogListSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: t('blog.title'),
  description:
    'Articles on Microsoft 365 architecture, Power Platform governance, security and compliance, and Microsoft 365 Copilot adoption.',
  url: canonicalURL.href,
  mainEntity: {
    '@type': 'ItemList',
    itemListElement: posts
      .slice((currentPage - 1) * POSTS_PER_PAGE, currentPage * POSTS_PER_PAGE)
      .map((post, index) => {
        const postUrl = new URL(`/blog/${post.slug}`, Astro.site).href;
        const postImage = post.data.image
          ? new URL(post.data.image, Astro.site).href
          : undefined;

        return {
          '@type': 'ListItem',
          position: index + 1 + (currentPage - 1) * POSTS_PER_PAGE,
          item: {
            '@type': 'BlogPosting',
            name: post.data.title,
            url: postUrl,
            image: postImage ? [postImage] : undefined,
          },
        };
      }),
  },
};
---

<MainLayout
  title={t('blog.title')}
  description="Articles on Microsoft 365 architecture, Power Platform governance, security and compliance, and Microsoft 365 Copilot adoption."
>
  <head>
    <script type="application/ld+json" set:html={JSON.stringify(blogListSchema)} />
  </head>
  <section class="bg-white py-20">
    <div class="mx-auto max-w-[1600px] px-6 sm:px-8 lg:px-12">
      <BlogHero />

      <!-- Separator -->
      <div class="my-12 border-t border-gray-200"></div>

      <!-- Sidebar + Content Layout -->
      <div class="flex flex-col gap-6 lg:flex-row lg:gap-8">
        <!-- Sidebar -->
        <aside class="lg:w-48 lg:flex-shrink-0">
          <div class="sticky top-8 space-y-4">
            <!-- Categories -->
            <div>
              <h2 class="mb-2">Latest</h2>
              <nav class="space-y-1">
                <a
                  href="/blog"
                  class="block rounded-md px-2 py-1.5 text-sm text-gray-700 transition-colors hover:bg-gray-100"
                >
                  All Posts
                </a>
              </nav>
            </div>

            <!-- Topics -->
            <div>
              <h2 class="mb-2">Topics</h2>
              <nav class="space-y-1">
                {
                  blogCategories.map((category) => (
                    <a
                      href={`/blog/category/${category.slug}`}
                      class="block rounded-md px-2 py-1.5 text-sm text-gray-700 transition-colors hover:bg-gray-100"
                    >
                      {category.label}
                    </a>
                  ))
                }
              </nav>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1">
          <BlogGrid posts={posts} currentPage={currentPage} postsPerPage={POSTS_PER_PAGE} />
        </div>
      </div>
    </div>
  </section>
</MainLayout>
