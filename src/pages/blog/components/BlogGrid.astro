---
import Card from '@components/cards/Card.astro';
import EmptyState from '@components/ui/EmptyState.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

interface Props {
  posts?: CollectionEntry<'blog'>[];
  currentPage?: number;
  postsPerPage?: number;
}

const { posts: providedPosts, currentPage = 1, postsPerPage = 9 } = Astro.props;

const allPosts =
  providedPosts ??
  (await getCollection('blog', ({ data }) => {
    return !data.draft;
  }));

const posts = allPosts.sort(
  (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

const totalPages = Math.ceil(posts.length / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const pagedPosts = posts.slice(startIndex, startIndex + postsPerPage);

const normalizeTags = (tags: string[]) => tags.map((tag) => tag.toLowerCase());
const relatedPostsBySlug = new Map<string, CollectionEntry<'blog'>[]>();

posts.forEach((post) => {
  const postTags = new Set(normalizeTags(post.data.tags ?? []));
  if (postTags.size === 0) {
    relatedPostsBySlug.set(post.slug, []);
    return;
  }

  const related = posts
    .filter((candidate) => candidate.slug !== post.slug)
    .map((candidate) => {
      const candidateTags = normalizeTags(candidate.data.tags ?? []);
      const score = candidateTags.reduce(
        (count, tag) => count + (postTags.has(tag) ? 1 : 0),
        0
      );
      return { candidate, score };
    })
    .filter((item) => item.score > 0)
    .sort(
      (a, b) =>
        b.score - a.score ||
        b.candidate.data.publishDate.getTime() - a.candidate.data.publishDate.getTime()
    )
    .slice(0, 2)
    .map((item) => item.candidate);

  relatedPostsBySlug.set(post.slug, related);
});
---

{posts.length === 0 ? (
  <EmptyState
    icon="ðŸ“"
    title="No blog posts yet"
    description="We're working on creating amazing content for you. Check back soon!"
    actionText="Go to Home"
    actionUrl="/"
  />
) : (
  <>
    <!-- Posts Grid -->
    <div class="mb-12 grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
      {
        pagedPosts.map((post) => {
          const related = relatedPostsBySlug.get(post.slug) ?? [];

          return (
            <div class="space-y-3">
              <Card
                title={post.data.title}
                description={post.data.description}
                href={`/blog/${post.slug}`}
                image={post.data.image ?? ''}
                date={post.data.publishDate}
                tags={post.data.tags}
              />
              {
                related.length > 0 && (
                  <div class="rounded-lg border border-gray-200 bg-gray-50 px-4 py-3 text-xs text-gray-600">
                    <div class="text-gray-500">Related posts</div>
                    <div class="mt-1 flex flex-col gap-1">
                      {related.map((relatedPost) => (
                        <a
                          href={`/blog/${relatedPost.slug}`}
                          class="text-blue-600 hover:text-blue-700"
                        >
                          {relatedPost.data.title}
                        </a>
                      ))}
                    </div>
                  </div>
                )
              }
            </div>
          );
        })
      }
    </div>

    <!-- Pagination -->
    {
      totalPages > 1 && (
        <div class="flex justify-center gap-2">
          {Array.from({ length: totalPages }, (_, i) => (
            <a
              href={i === 0 ? '/blog' : `/blog/${i + 1}`}
              class:list={[
                'rounded-lg border px-4 py-2 transition-colors',
                i + 1 === currentPage
                  ? 'border-gray-900 text-gray-900'
                  : 'border-gray-300 hover:border-blue-600 hover:text-blue-600',
              ]}
            >
              {i + 1}
            </a>
          ))}
        </div>
      )
    }
  </>
)}
