---
import { getCollection } from 'astro:content';
import DocLayout from '@layouts/DocLayout.astro';
import { useTranslations } from '@i18n/utils';
import JsonLd from '@components/seo/JsonLd.astro';

const t = useTranslations('en');

const categoryLabels = {
  m365: t('projects.filter_m365'),
  'power-platform': t('projects.filter_power-platform'),
  'security-compliance': t('projects.filter_security-compliance'),
  'copilot-governance': t('projects.filter_copilot-governance'),
};

export async function getStaticPaths() {
  const projectEntries = await getCollection('projects');

  // If no projects exist, return empty array to prevent build errors
  if (projectEntries.length === 0) {
    return [];
  }

  return projectEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const imageUrl = entry.data.image ? new URL(entry.data.image, Astro.site).href : undefined;
const projectSchema: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'CreativeWork',
  name: entry.data.title,
  description: entry.data.description,
  url: canonicalURL.href,
  author: {
    '@type': 'Person',
    name: 'Sebastian Georgian Utoiu',
    url: new URL('/', Astro.site).href,
  },
  publisher: {
    '@type': 'Person',
    name: 'Sebastian Georgian Utoiu',
    url: new URL('/', Astro.site).href,
  },
  keywords: entry.data.tags?.join(', '),
};

if (imageUrl) {
  projectSchema.image = [imageUrl];
}

// Build actions array
const actions = [];
if (entry.data.projectUrl) {
  actions.push({
    label: 'View Live Project',
    href: entry.data.projectUrl,
    variant: 'primary' as const,
    icon: 'external' as const,
  });
}
if (entry.data.githubUrl) {
  actions.push({
    label: 'View on GitHub',
    href: entry.data.githubUrl,
    variant: 'secondary' as const,
    icon: 'github' as const,
  });
}
---

<DocLayout
  title={entry.data.title}
  description={entry.data.description}
  headings={headings}
  breadcrumb={{ label: 'Projects', href: '/projects' }}
  backLink={{ label: 'Back to Projects', href: '/projects' }}
  tags={entry.data.tags}
  {...entry.data.image ? { image: entry.data.image } : {}}
  {...actions.length > 0 ? { actions } : {}}
  meta={[
    {
      label: 'Category',
      value: categoryLabels[entry.data.category] ?? entry.data.category,
      icon: 'ðŸ“',
    },
  ]}
>
  <Fragment slot="head">
    <JsonLd data={projectSchema} />
  </Fragment>
  <Content />
</DocLayout>
